name: CI/CD for Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      azure_location:
        description: 'Azure region for deployment'
        required: true
        type: choice
        default: 'canadacentral'
        options:
          - canadacentral
          - canadaeast
          - eastus
          - eastus2
          - westus
          - westus2
          - westeurope
          - northeurope
      instance_number:
        description: 'Instance number for resource naming'
        required: true
        type: string
        default: '002'

permissions:
  attestations: write
  id-token: write
  contents: write
  packages: write
  security-events: write

env:
  INSTANCE_NUMBER: ${{ github.event.inputs.instance_number || '002' }}
  AZURE_LOCATION: ${{ github.event.inputs.azure_location || 'canadacentral' }}
  AZURE_WEBAPP_NAME: app-gh-aspnet-webapp-${{ github.event.inputs.instance_number || '002' }}
  SRC_PROJECT_PATH: "/webapp01/webapp01.csproj"
  AZURE_WEBAPP_PACKAGE_PATH: "./src"
  DOTNET_VERSION: "9.0.x"
  AZURE_ACR_NAME: crdevsecopscldev${{ github.event.inputs.instance_number || '002' }}

jobs:
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    outputs:
      acr_name: ${{ steps.deploy.outputs.acr_name }}
      webapp_name: ${{ steps.deploy.outputs.webapp_name }}
      webapp_url: ${{ steps.deploy.outputs.webapp_url }}
    steps:
      - uses: actions/checkout@v5

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep Infrastructure
        id: deploy
        shell: pwsh
        run: |
          $instanceNumber = "${{ env.INSTANCE_NUMBER }}"
          $location = "${{ env.AZURE_LOCATION }}"
          
          # Calculate resource names based on instance number
          $acrName = "crdevsecopscldev$instanceNumber"
          $appServicePlanName = "asp-gh-aspnet-webapp-$instanceNumber"
          $webAppName = "app-gh-aspnet-webapp-$instanceNumber"
          $resourceGroupName = "rg-gh-aspnet-webapp-$instanceNumber"
          $containerImage = "$acrName.azurecr.io/webapp01:latest"
          
          # Deployment name based only on instance number for idempotence
          $deploymentName = "deploy-infra-$instanceNumber"
          
          Write-Host "=== Azure Infrastructure Deployment ===" -ForegroundColor Cyan
          Write-Host "Instance Number: $instanceNumber" -ForegroundColor Green
          Write-Host "Location: $location" -ForegroundColor Green
          Write-Host "ACR Name: $acrName" -ForegroundColor Green
          Write-Host "App Service Plan: $appServicePlanName" -ForegroundColor Green
          Write-Host "Web App Name: $webAppName" -ForegroundColor Green
          Write-Host "Resource Group: $resourceGroupName" -ForegroundColor Green
          Write-Host "Deployment Name: $deploymentName" -ForegroundColor Green
          
          # Deploy using inline parameters instead of parameters file
          az deployment sub create `
            --name $deploymentName `
            --location $location `
            --template-file ./infra/main.bicep `
            --parameters acrName=$acrName `
            --parameters acrSku=Basic `
            --parameters appServicePlanName=$appServicePlanName `
            --parameters webAppName=$webAppName `
            --parameters location=$location `
            --parameters containerImage=$containerImage `
            --parameters resourceGroupName=$resourceGroupName
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Deployment failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "Deployment completed successfully!" -ForegroundColor Green
          
          # Set outputs for subsequent jobs
          echo "acr_name=$acrName" >> $env:GITHUB_OUTPUT
          echo "webapp_name=$webAppName" >> $env:GITHUB_OUTPUT
          echo "webapp_url=https://$webAppName.azurewebsites.net" >> $env:GITHUB_OUTPUT

      - name: Configure ACR Managed Identity
        shell: pwsh
        run: |
          $webAppName = "${{ steps.deploy.outputs.webapp_name }}"
          $resourceGroupName = "rg-gh-aspnet-webapp-${{ env.INSTANCE_NUMBER }}"
          
          Write-Host "Configuring ACR managed identity authentication..." -ForegroundColor Yellow
          
          # Verify ACR managed identity configuration
          $config = az webapp config show --name $webAppName --resource-group $resourceGroupName --query "acrUseManagedIdentityCreds" -o tsv
          
          if ($config -ne "true") {
            Write-Host "Setting acrUseManagedIdentityCreds=true..." -ForegroundColor Cyan
            az webapp config set --name $webAppName --resource-group $resourceGroupName --generic-configurations '{"acrUseManagedIdentityCreds": true}'
          } else {
            Write-Host "ACR managed identity already configured" -ForegroundColor Green
          }

      - name: logout
        run: az logout

  cicd:
    name: Build and Deploy to Azure Web App
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    steps:
      # Checkout the repo
      - uses: actions/checkout@v5

      # Setup .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Run dotnet build and publish
      - name: dotnet build and publish
        run: |
          dotnet restore ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}${{ env.SRC_PROJECT_PATH }}
          dotnet build --configuration Release ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}${{ env.SRC_PROJECT_PATH }}
          dotnet publish -c Release --property:PublishDir='bin/publish' ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}${{ env.SRC_PROJECT_PATH }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Deploy to Azure Web apps
      - name: "Run Azure webapp deploy action using publish profile credentials"
        if: false # This disables the action
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }} # Replace with your app name
          package: "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/webapp01/bin/publish"

      - name: ACR Login via OIDC
        run: az acr login --name ${{ env.AZURE_ACR_NAME }}

      - name: Build and Push Docker Image
        run: |
          docker build ./src/webapp01 --file ./src/webapp01/Dockerfile -t ${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:${{ github.sha }}
          docker tag ${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:${{ github.sha }} ${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:latest
          docker push ${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:${{ github.sha }}
          docker push ${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:latest

      - name: Azure Web Apps Deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: "${{ env.AZURE_ACR_NAME }}.azurecr.io/webapp01:${{ github.sha }}"

      - name: logout
        run: |
          az logout

  # https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations/using-artifact-attestations-and-reusable-workflows-to-achieve-slsa-v1-build-level-3
  container-build-publish:
    name: Build and Publish Container Image
    uses: devopsabcs-engineering/devsecops-reusable-workflows/.github/workflows/container.yml@main
    with:
      # This is used for tagging the container image
      version: v1.0.0
      container-file: ./src/webapp01/Dockerfile
      container-context: ./src/webapp01
      container-name: "${{ github.repository }}/webapp01"
